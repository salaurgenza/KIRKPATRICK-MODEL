<!doctype html>
<html lang="it">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Valutazione Livello 3 - Kirkpatrick</title>
    <style>
        :root {
            --bg: #f7f9fb;
            --card: #ffffff;
            --accent: #0b63c6;
            --muted: #6b7280
        }

        body {
            font-family: Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;
            margin: 0;
            background: var(--bg);
            color: #111
        }

        .container {
            max-width: 900px;
            margin: 32px auto;
            padding: 20px
        }

        .card {
            background: var(--card);
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(16,24,40,0.06);
            padding: 20px;
            margin-bottom: 16px
        }

        h1 {
            margin: 0 0 8px 0;
            font-size: 20px
        }

        p.lead {
            color: var(--muted);
            margin: 0 0 12px 0
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600
        }

        .row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap
        }

        .col {
            flex: 1;
            min-width: 220px
        }

        .likert {
            display: flex;
            gap: 6px;
            align-items: center
        }

            .likert input {
                display: none
            }

            .likert label {
                padding: 8px 10px;
                border-radius: 8px;
                background: #efefef;
                cursor: pointer
            }

            .likert input:checked + label {
                background: var(--accent);
                color: white
            }

        textarea {
            width: 100%;
            min-height: 90px;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #e6e9ee
        }

        input[type=text], input[type=date] {
            width: 100%;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #e6e9ee
        }

        .btn {
            display: inline-block;
            padding: 10px 14px;
            border-radius: 10px;
            border: 0;
            background: var(--accent);
            color: #fff;
            cursor: pointer
        }

            .btn.secondary {
                background: #6b7280
            }

        .muted {
            color: var(--muted);
            font-size: 13px
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px
        }

        th, td {
            padding: 8px;
            border-bottom: 1px solid #eef2f7;
            text-align: left
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>Valutazione - Livello 3 (Comportamento)</h1>
            <p class="lead">Valutazione dell’applicazione pratica delle competenze infermieristiche in sala operatoria di oculistica. Destinato all’osservatore/tutor.</p>

            <form id="behaviorForm">
                <div class="row">
                    <div class="col">
                        <label for="participant">Infermiere osservato</label>
                        <input type="text" id="participant" name="participant" placeholder="Nome o ID">
                    </div>
                    <div class="col">
                        <label for="observer">Osservatore / Tutor</label>
                        <input type="text" id="observer" name="observer" placeholder="Nome osservatore">
                    </div>
                    <div class="col">
                        <label for="date">Data osservazione</label>
                        <input type="date" id="date" name="date">
                    </div>
                </div>

                <hr>

                <div class="card">
                    <h3>Precisione tecnica</h3>
                    <div>Conoscenza degli strumenti</div>
                    <div class="likert">
                        <input type="radio" id="prep1" name="preparation" value="1"><label for="prep1">1</label>
                        <input type="radio" id="prep2" name="preparation" value="2"><label for="prep2">2</label>
                        <input type="radio" id="prep3" name="preparation" value="3"><label for="prep3">3</label>
                        <input type="radio" id="prep4" name="preparation" value="4"><label for="prep4">4</label>
                        <input type="radio" id="prep5" name="preparation" value="5"><label for="prep5">5</label>
                    </div>

                    <div>Corretta preparazione del servitore</div>
                    <div class="likert">
                        <input type="radio" id="servitorPrep1" name="servitorPreparation" value="1"><label for="servitorPrep1">1</label>
                        <input type="radio" id="servitorPrep2" name="servitorPreparation" value="2"><label for="servitorPrep2">2</label>
                        <input type="radio" id="servitorPrep3" name="servitorPreparation" value="3"><label for="servitorPrep3">3</label>
                        <input type="radio" id="servitorPrep4" name="servitorPreparation" value="4"><label for="servitorPrep4">4</label>
                        <input type="radio" id="servitorPrep5" name="servitorPreparation" value="5"><label for="servitorPrep5">5</label>
                    </div>

                </div>

                <div class="card">
                    <h3>Gestione del tempo e organizzazione</h3>
                    <div>Setup Strumentario chirurgico</div>
                    <div class="likert">
                        <input type="radio" id="timing1" name="setupTiming" value="1"><label for="timing1">1</label>
                        <input type="radio" id="timing2" name="setupTiming" value="2"><label for="timing2">2</label>
                        <input type="radio" id="timing3" name="setupTiming" value="3"><label for="timing3">3</label>
                        <input type="radio" id="timing4" name="setupTiming" value="4"><label for="timing4">4</label>
                        <input type="radio" id="timing5" name="setupTiming" value="5"><label for="timing5">5</label>
                    </div>

                    <div>Allestimento servitore</div>
                    <div class="likert">
                        <input type="radio" id="setupPriority1" name="setupPriority" value="1"><label for="setupPriority1">1</label>
                        <input type="radio" id="setupPriority2" name="setupPriority" value="2"><label for="setupPriority2">2</label>
                        <input type="radio" id="setupPriority3" name="setupPriority" value="3"><label for="setupPriority3">3</label>
                        <input type="radio" id="setupPriority4" name="setupPriority" value="4"><label for="setupPriority4">4</label>
                        <input type="radio" id="setupPriority5" name="setupPriority" value="5"><label for="setupPriority5">5</label>
                    </div>
                    <div>Rispetto dei tempi chirurgici</div>
                    <div class="likert">
                        <input type="radio" id="surgicalTiming1" name="surgicalTiming" value="1"><label for="surgicalTiming1">1</label>
                        <input type="radio" id="surgicalTiming2" name="surgicalTiming" value="2"><label for="surgicalTiming2">2</label>
                        <input type="radio" id="surgicalTiming3" name="surgicalTiming" value="3"><label for="surgicalTiming3">3</label>
                        <input type="radio" id="surgicalTiming4" name="surgicalTiming" value="4"><label for="surgicalTiming4">4</label>
                        <input type="radio" id="surgicalTiming5" name="surgicalTiming" value="5"><label for="surgicalTiming5">5</label>
                    </div>
                    <div>Uso corretto dispositivi Medici</div>
                    <div class="likert">
                        <input type="radio" id="safetyDevices1" name="safetyDevices" value="1"><label for="safetyDevices1">1</label>
                        <input type="radio" id="safetyDevices2" name="safetyDevices" value="2"><label for="safetyDevices2">2</label>
                        <input type="radio" id="safetyDevices3" name="safetyDevices" value="3"><label for="safetyDevices3">3</label>
                        <input type="radio" id="safetyDevices4" name="safetyDevices" value="4"><label for="safetyDevices4">4</label>
                        <input type="radio" id="safetyDevices5" name="safetyDevices" value="5"><label for="safetyDevices5">5</label>
                    </div>
                </div>

                <div class="card">
                    <h3>Tecniche di strumentazione</h3>
                    <div>Acquisizione tecniche di base</div>
                    <div class="likert">
                        <input type="radio" id="basicTech1" name="basicTechniques" value="1"><label for="basicTech1">1</label>
                        <input type="radio" id="basicTech2" name="basicTechniques" value="2"><label for="basicTech2">2</label>
                        <input type="radio" id="basicTech3" name="basicTechniques" value="3"><label for="basicTech3">3</label>
                        <input type="radio" id="basicTech4" name="basicTechniques" value="4"><label for="basicTech4">4</label>
                        <input type="radio" id="basicTech5" name="basicTechniques" value="5"><label for="basicTech5">5</label>
                    </div>

                    <div>Riconoscimento fasi chirurgiche e anticipazione strumentario</div>
                    <div class="likert">
                        <input type="radio" id="anticipation1" name="anticipation" value="1"><label for="anticipation1">1</label>
                        <input type="radio" id="anticipation2" name="anticipation" value="2"><label for="anticipation2">2</label>
                        <input type="radio" id="anticipation3" name="anticipation" value="3"><label for="anticipation3">3</label>
                        <input type="radio" id="anticipation4" name="anticipation" value="4"><label for="anticipation4">4</label>
                        <input type="radio" id="anticipation5" name="anticipation" value="5"><label for="anticipation5">5</label>
                    </div>
                </div>

                <div class="card">
                    <h3>Adattamento a imprevisti</h3>
                    <div>Reazioni corrette a cambiamenti o complicazioni</div>
                    <div class="likert">
                        <input type="radio" id="adapt1" name="adaptability" value="1"><label for="adapt1">1</label>
                        <input type="radio" id="adapt2" name="adaptability" value="2"><label for="adapt2">2</label>
                        <input type="radio" id="adapt3" name="adaptability" value="3"><label for="adapt3">3</label>
                        <input type="radio" id="adapt4" name="adaptability" value="4"><label for="adapt4">4</label>
                        <input type="radio" id="adapt5" name="adaptability" value="5"><label for="adapt5">5</label>
                    </div>

                    <div>Proattività nel prevedere esigenze del team</div>
                    <div class="likert">
                        <input type="radio" id="proactive1" name="proactivity" value="1"><label for="proactive1">1</label>
                        <input type="radio" id="proactive2" name="proactivity" value="2"><label for="proactive2">2</label>
                        <input type="radio" id="proactive3" name="proactivity" value="3"><label for="proactive3">3</label>
                        <input type="radio" id="proactive4" name="proactivity" value="4"><label for="proactive4">4</label>
                        <input type="radio" id="proactive5" name="proactivity" value="5"><label for="proactive5">5</label>
                    </div>
                </div>


                <div class="card">
                    <label>Osservazioni e commenti generali</label>
                    <textarea id="comments" name="comments" placeholder="Inserire note aggiuntive sull’applicazione pratica delle competenze"></textarea>
                </div>

                <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
                    <button type="button" class="btn" onclick="saveResponse()">Salva osservazione</button>
                    <button type="button" class="btn secondary" onclick="showSummary()">Visualizza riepilogo</button>
                    <button type="button" class="btn secondary" onclick="exportCSV()">Esporta CSV</button>
                    <button type="button" class="btn secondary" onclick="exportPDF()">Esporta PDF</button>
                </div>
            </form>

        </div>

        <div class="card" id="summaryCard" style="display:none">
            <h2>Riepilogo osservazioni</h2>
            <p class="muted">Osservazioni salvate localmente. Puoi esportarle per analisi o reportistica.</p>
            <div id="summary"></div>
            <div style="margin-top:12px"><button class="btn secondary" onclick="clearResponses()">Elimina tutte le osservazioni</button></div>
        </div>

    </div>

    <script>const STORAGE_KEY = 'kirkpatrick_level3_responses';

        function getFormData() {
            const form = document.getElementById('behaviorForm');
            const fd = new FormData(form);
            const obj = {};
            for (const [k, v] of fd.entries()) obj[k] = v;
            obj.timestamp = new Date().toISOString();
            return obj;
        }

        function saveResponse() {
            const data = getFormData();
            // Ho cambiato il controllo di base per usare la nuova chiave 'preparation'
            if (!data.preparation) { alert('Valuta almeno la preparazione degli strumenti.'); return; }
            const arr = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            arr.push(data);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
            alert('Osservazione salvata localmente.');
            document.getElementById('behaviorForm').reset();
            // Imposta la data corrente dopo il reset
            document.getElementById('date').value = new Date().toISOString().slice(0, 10);
        }

        function showSummary() {
            const arr = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const container = document.getElementById('summary');
            container.innerHTML = '';
            if (arr.length === 0) {
                container.innerHTML = '<p class="muted">Nessuna osservazione disponibile.</p>';
                document.getElementById('summaryCard').style.display = 'block';
                return;
            }
            document.getElementById('summaryCard').style.display = 'block';

            // Visualizzazione dei commenti
            const h = document.createElement('h3'); h.textContent = 'Commenti / Osservazioni'; container.appendChild(h);
            const ul = document.createElement('ul');
            arr.slice().reverse().forEach(r => {
                if (r.comments && r.comments.trim()) {
                    const li = document.createElement('li');
                    li.textContent = `(${new Date(r.timestamp).toLocaleString()}) ${r.comments}`;
                    ul.appendChild(li);
                }
            });
            if (!ul.children.length) {
                const p = document.createElement('p');
                p.className = 'muted';
                p.textContent = 'Nessun commento';
                container.appendChild(p);
            } else {
                container.appendChild(ul);
            }
        }

        function exportCSV() {
            const arr = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            if (arr.length === 0) { alert('Nessuna osservazione da esportare'); return; }
            const keys = Object.keys(arr[0]);
            const csvRows = [];
            csvRows.push(keys.join(','));
            arr.forEach(obj => {
                // Sostituisci le virgole e racchiudi tra virgolette i valori per evitare problemi con il CSV
                const vals = keys.map(k => `"${(obj[k] || '').toString().replace(/"/g, '""')}"`);
                csvRows.push(vals.join(','));
            });
            const blob = new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'kirkpatrick_level3_responses.csv';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        function clearResponses() {
            if (!confirm('Eliminare tutte le osservazioni salvate?')) return;
            localStorage.removeItem(STORAGE_KEY);
            showSummary();
            alert('Tutte le osservazioni sono state eliminate.');
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Imposta la data corrente al caricamento
            document.getElementById('date').value = new Date().toISOString().slice(0, 10);
        });

        async function exportPDF() {
            const arr = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            if (arr.length === 0) { alert('Nessuna osservazione da esportare'); return; }

            // Verifica se jsPDF è disponibile
            if (!window.jspdf || !window.jspdf.jsPDF) {
                alert("Libreria jsPDF non caricata. Riprova o controlla la connessione.");
                return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Mappatura aggiornata per le chiavi del form (incluse le correzioni)
            const keyMap = {
                participant: 'Infermiere Osservato',
                observer: 'Osservatore / Tutor',
                date: 'Data Osservazione',
                // Precisione tecnica
                preparation: 'Precisione Tecnica - Conoscenza Strumenti (1-5)',
                servitorPreparation: 'Precisione Tecnica - Corretta Preparazione Servitore (1-5)',
                // Gestione del tempo e organizzazione
                setupTiming: 'Gestione Tempo - Setup Strumentario (1-5)',
                setupPriority: 'Gestione Tempo - Allestimento Servitore (1-5)',
                surgicalTiming: 'Gestione Tempo - Rispetto Tempi Chirurgici (1-5)',
                safetyDevices: 'Gestione Tempo - Uso Corretto Dispositivi Medici (1-5)',
                // Tecniche di strumentazione
                basicTechniques: 'Tecniche - Acquisizione Tecniche di Base (1-5)',
                anticipation: 'Tecniche - Riconoscimento Fasi e Anticipazione (1-5)',
                // Adattamento a imprevisti
                adaptability: 'Adattamento - Reazioni a Cambiamenti/Complicazioni (1-5)',
                proactivity: 'Adattamento - Proattività (1-5)',

                comments: 'Osservazioni Generali',
                timestamp: 'Timestamp Salvataggio'
            };

            let y = 10;
            const lineHeight = 7;
            const pageWidth = doc.internal.pageSize.getWidth();
            const textMargin = 10;
            const maxLineWidth = pageWidth - 2 * textMargin;

            doc.setFontSize(16);
            doc.text("Riepilogo osservazioni - Kirkpatrick Livello 3 (Comportamento)", textMargin, y);
            y += lineHeight * 2;

            arr.forEach((r, idx) => {
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                let headerText = `OSSERVAZIONE ${idx + 1} - ${new Date(r.timestamp).toLocaleString()}`;
                doc.text(headerText, textMargin, y);
                y += lineHeight;

                doc.setFont(undefined, 'normal');
                Object.keys(r).forEach(k => {
                    const label = keyMap[k] || k;
                    if (r[k]) {
                        let value = r[k].toString().trim();
                        // Formattazione speciale per i commenti per una migliore leggibilità
                        if (k === 'comments' && value) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Osservazioni Generali:', textMargin, y);
                            y += lineHeight * 0.8;
                            doc.setFont(undefined, 'normal');
                            const splitText = doc.splitTextToSize(value, maxLineWidth - 5);
                            doc.text(splitText, textMargin + 5, y);
                            y += splitText.length * lineHeight;
                        } else if (k !== 'timestamp') {
                            let line = `${label}: ${value}`;
                            // Fissa le intestazioni, non il timestamp che è troppo tecnico
                            if (label !== 'Timestamp Salvataggio') {
                                const splitText = doc.splitTextToSize(line, maxLineWidth);
                                doc.text(splitText, textMargin, y);
                                y += splitText.length * lineHeight;
                            }
                        }

                        if (y > 280) {
                            doc.addPage();
                            y = 10;
                        }
                    }
                });
                y += lineHeight;

                // Linea separatrice tra le osservazioni
                doc.line(textMargin, y - (lineHeight / 2), pageWidth - textMargin, y - (lineHeight / 2));
                y += lineHeight;

                if (y > 280) {
                    doc.addPage();
                    y = 10;
                }
            });

            doc.save('kirkpatrick_level3_responses.pdf');
        }</script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</body>
</html>